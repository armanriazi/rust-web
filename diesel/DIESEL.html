<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DIESEL - Rust-Web</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../TEMPLATE.html"><strong aria-hidden="true">1.</strong> TEMPLATE</a></li><li class="chapter-item expanded "><a href="../rust/RUST.html"><strong aria-hidden="true">2.</strong> RUST</a></li><li class="chapter-item expanded "><a href="../diesel/DIESEL.html" class="active"><strong aria-hidden="true">3.</strong> DIESEL</a></li><li class="chapter-item expanded "><a href="../WEB_R3.html"><strong aria-hidden="true">4.</strong> WEB_R3</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../diesel/diesel_v2/DIESEL_VER_2.html"><strong aria-hidden="true">5.</strong> DIESEL_VER_2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../diesel/diesel_v2/sqlite/SET_UP_DIESEL_SQLITE.html"><strong aria-hidden="true">5.1.</strong> SET_UP_DIESEL_SQLITE</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../diesel/diesel_v2/sqlite/getting_started_step_1/SETUP_DIESEL_STEP_1.html"><strong aria-hidden="true">5.1.1.</strong> SETUP_DIESEL_STEP_1</a></li><li class="chapter-item expanded "><a href="../diesel/diesel_v2/sqlite/getting_started_step_2/SETUP_DIESEL_STEP_2.html"><strong aria-hidden="true">5.1.2.</strong> SETUP_DIESEL_STEP_2</a></li><li class="chapter-item expanded "><a href="../diesel/diesel_v2/sqlite/getting_started_step_3/SETUP_DIESEL_STEP_3.html"><strong aria-hidden="true">5.1.3.</strong> SETUP_DIESEL_STEP_3</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../diesel/web_edu/WEB_EDU.html"><strong aria-hidden="true">6.</strong> WEB_EDU</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../diesel/web_edu/web_edu_setup/SETUP_WEB_EDU.html"><strong aria-hidden="true">6.1.</strong> SETUP_WEB_EDU</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust-Web</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="diesel"><a class="header" href="#diesel">Diesel</a></h1>
<p>Diesel is one of the most popular and stable ORM tools in Rust.</p>
<p>In this lesson, we’ll learn to install and configure it for our projects.</p>
<p>We want to install the required database drivers. Instructions for installing these drivers for Linux/Mac can be found here.</p>
<p>Install database drivers on Windows
Instructions for installing the three most popular relational database management systems (RDBMS) on Windows are below.</p>
<h2 id="sqlite"><a class="header" href="#sqlite">SQLite</a></h2>
<p>Download precompile Windows binaries.
Extract both archives to folder C:\sqlite3. We can name this folder anything.
Open developer command prompt for Visual Studio (VS) by typing “developer command” in the Windows search bar.
Go to the folder with the extracted source code and binary files (via opened cmd or PowerShell).
Run lib /DEF:sqlite3.def /OUT:sqlite3.lib /MACHINE:x64.
Add C:\sqlite3 to the environment variable PATH.
Create an environment variable called SQLITE3_LIB_DIR also pointing to C:\sqlite3.</p>
<h2 id="mysql"><a class="header" href="#mysql">MySQL</a></h2>
<p>Download the MySQL connector.</p>
<p>Locate mysqlclient.lib. It might be installed in C:\Program Files\MySQL\MySQL Connector C 6.1\lib\vs14 if you use the MSI Installer.</p>
<p>Create an environment variable called MYSQLCLIENT_LIB_DIR that points to the previous folder.</p>
<h2 id="postgresql"><a class="header" href="#postgresql">PostgreSQL</a></h2>
<p>Download the installer and install PostgreSQL.
Add the bin directory to the PATH environment variable.
Create a variable named PQ_LIB_DIR pointing to the lib directory.
Prepare Diesel
Run the next command with the corresponding RDBMS. In the example, we are using SQLite.</p>
<pre><code>cargo install diesel_cli --no-default-features --features sqlite
</code></pre>
<h3 id="setup-orm"><a class="header" href="#setup-orm">Setup ORM</a></h3>
<p>Finally, we can create our database with the below command.</p>
<pre><code>diesel setup
</code></pre>
<p>We need to specify the database_url to create the testing database.</p>
<pre><code>diesel setup --database-url='web_edu_test.sqlite
</code></pre>
<h2 id="migration"><a class="header" href="#migration">Migration</a></h2>
<h3 id="migration-create-products"><a class="header" href="#migration-create-products">Migration Create Products</a></h3>
<pre><code>diesel migration generate create_products
</code></pre>
<p>The previous command will create two files named up.sql and down.sql inside the migrations folder.</p>
<p>We’ll enter the below code in the up.sql file.</p>
<pre><code class="language-sql">CREATE TABLE products (
  id INTEGER PRIMARY KEY,
  name VARCHAR NOT NULL,
  cost DOUBLE NOT NULL,
  active BOOLEAN NOT NULL DEFAULT 0 --Sqlite does not have a Boolean value
)
</code></pre>
<p>Let’s work with the down.sql file now.</p>
<pre><code>drop table products
</code></pre>
<p>Next:</p>
<pre><code>diesel migration run
</code></pre>
<hr />
<h3 id="migration-product-variants"><a class="header" href="#migration-product-variants">Migration Product Variants</a></h3>
<p>Next:
We need to create another table to save shoe variants.</p>
<pre><code>diesel migration generate create_variants
</code></pre>
<p>Below is how the up.sql file will look.</p>
<pre><code class="language-sql">CREATE TABLE variants (
   id INTEGER PRIMARY KEY NOT NULL, 
   name VARCHAR NOT NULL
);

CREATE TABLE products_variants (
   id INTEGER PRIMARY KEY NOT NULL, 
   variant_id INTEGER NOT NULL,
   product_id INTEGER NOT NULL,
   value VARCHAR,
   FOREIGN KEY(variant_id) REFERENCES variants(id),
   FOREIGN KEY(product_id) REFERENCES products(id)   
);
</code></pre>
<p>Below is how the down.sql file.</p>
<pre><code>drop table variants;
drop table products_variants;
</code></pre>
<h3 id="migration-for-test-db"><a class="header" href="#migration-for-test-db">Migration For Test DB</a></h3>
<p>We did not include indexes in the above code widgets, but you should do so according to your frequent queries. Next, we run the migrations.</p>
<pre><code>diesel migration run
diesel migration run --database-url='db/web_edu_test.sqlite'
</code></pre>
<h3 id="migration-for-edit-form"><a class="header" href="#migration-for-edit-form">Migration For Edit Form</a></h3>
<p>The delete method is easier to implement. However, we should make some modifications in our SQL first. We open the up.sql file and update it with the below commands.
The clause ON DELETE CASCADE will allow us to delete the relations with variants every time we delete a product.</p>
<pre><code class="language-sql">CREATE TABLE products_variants (
   id INTEGER PRIMARY KEY NOT NULL, 
   variant_id INTEGER NOT NULL,
   product_id INTEGER NOT NULL,
   value VARCHAR,
   FOREIGN KEY(variant_id) REFERENCES variants(id) ON DELETE CASCADE,
   FOREIGN KEY(product_id) REFERENCES products(id) ON DELETE CASCADE
);
</code></pre>
<p>Notice(In code): 
We need to be aware that SQLite does not enforce foreign keys, so we need to tell the database with the following command: </p>
<pre><code>connection.execute(&quot;PRAGMA foreign_keys = ON&quot;).unwrap();
</code></pre>
<p>We can see a couple of interesting lines in this test. First, we have the annotation #[should_panic(expected = &quot;NotFound&quot;)]We use this annotation to tell Rust that this test should effectively panic. This will happen when we try to show an inexistent product and unwrap an Err result.</p>
<pre><code>#[should_panic(expected = &quot;NotFound&quot;)]
</code></pre>
<h3 id="how-to-make-a-select--where-exists-query-with-diesel"><a class="header" href="#how-to-make-a-select--where-exists-query-with-diesel">How to make a <code>SELECT .... WHERE EXISTS</code> query with diesel?</a></h3>
<pre><code class="language-sql">SELECT * FROM user AS u
WHERE EXISTS(
    SELECT 0 FROM address AS a
    WHERE a.user_id = u.id
        AND a.city = 'Berlin'
)
</code></pre>
<blockquote>
</blockquote>
<pre><pre class="playground"><code class="language-rust no_run edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>diesel::table! {
    addresses (id) {
        id -&gt; Int4,
        user_id -&gt; Int4,
        city -&gt; Nullable&lt;Varchar&gt;,
    }
}

diesel::table! {
    users (id) {
        id -&gt; Int4,
        name -&gt; Varchar,
    }
}

diesel::joinable!(addresses -&gt; users (user_id));

diesel::allow_tables_to_appear_in_same_query!(
    addresses,
    users,
);
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>Response</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust edition2021">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let sub_query = addresses::table
    .select(0.into_sql::&lt;diesel::sql_types::Integer&gt;())
    .filter(addresses::user_id.eq(users::id))
    .filter(addresses::city.eq(&quot;Berlin&quot;));
let result = users::table.filter(diesel::dsl::exists(sub_query)).load::&lt;CompatibleType&gt;(&amp;mut conn)?;
<span class="boring">}
</span></code></pre></pre>
<h3 id="sorting-and-filtering"><a class="header" href="#sorting-and-filtering">Sorting and Filtering</a></h3>
<p><a href="https://cloudmaker.dev/sorting-and-filtering-with-diesel/">sorting-and-filtering-with-diesel</a></p>
<h1 id="references"><a class="header" href="#references">References</a></h1>
<p><a href="https://diesel.rs/guides/migration_guide.html#2-0-0-no_arg_sql_function">no_arg_sql_function</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rust/RUST.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../WEB_R3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rust/RUST.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../WEB_R3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
